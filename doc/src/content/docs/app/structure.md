+++
title = '架构'
[sidebar]
order = 1
+++

Vitium 是一个典型的 Web 2 全栈应用。它通过 HTTP 服务将 TRPG 玩家和游戏管理员，服务器管理员和 Vitium 模组开发者联系在一起。下图简单呈现了它的架构。

![Flowchart](asset/structure.svg)

## 客户端

**Vitium 客户端** 是一个 Web 前端应用。它被设计为部署在云上，并可以被任何服务器主动嵌入其前端页面中，通过被允许的跨域资源请求与服务端通信。客户端是用户（ TRPG 玩家与游戏管理员）浏览器中的主要交互对象，几乎所有游戏内和游戏外的用户操作都由客户端处理。

客户端不承担或极少承担游戏内玩法的计算任务。它应当只负责显示内置或模组的游戏界面，并根据显示的需要进行无状态的计算。

需要注意的是，客户端不应当被直接访问使用，而是应当由服务端嵌入其返回的页面中。也就是说，用户浏览器的 [源](https://developer.mozilla.org/zh-CN/docs/Web/API/URL/origin) 始终不是客户端，而是服务端。

我们会用伪域名 `client.vitium.dev` 指代客户端主机。

## 服务端

**Vitium 服务端** 是一个 Web 后端应用。它提供一个 HTTP 服务，或其升级协议如 [WebSocket](https://developer.mozilla.org/zh-CN/docs/Web/API/WebSocket) . 服务端被设计为能够容易地部署到任何现代消费级桌面硬件上，以允许所有人自建游戏服务。

服务端通过网络接收客户端发送的用户操作，并将结果同步给客户端。所有游戏内玩法的实际计算均通过服务端执行。这些计算可以被模组所扩展。

服务端希望具有良好的并发性能，它典型工况下的设计同时在线上限为 255 人，并会尽可能采用优化达成这一目标。

我们会用伪域名 `server.vitium.dev` 指代服务端主机。

## 模组

一个 **Vitium 模组** 是一系列第三方编写和打包的，符合 Vitium 所指定标准的静态资源与可执行脚本的集合。它可以被 Vitium 客户端和服务端所解释，并分别在其上实现添加，修改或删除特定视觉内容，用户交互或游戏机制的作用。一组进行游戏的客户端和服务端应当具有相同的模组。

模组可以托管到互联网上的任意一处。它通过 URL 分发到客户端和服务端，并由 Vitium 在需要时从互联网下载。

---

## 实现

用户将使用浏览器访问由服务端提供的 HTTP 服务。这时，正常情况下，服务端在返回的 HTML 页面中通过 `<iframe>` 标签嵌入客户端页面。客户端页面的具体 URL 可能不同，由服务端配置决定。

进一步地，当服务端这样做时，为了使客户端知道当前前端界面所操作的服务器（考虑到将有多个托管的服务端实例选择相同的客户端），服务端需要在 URL 查询参数中设置 `server` 为指向其 HTTP 服务根目录的 URL. 

```html
<!-- 
 我们使用 client.vitium.dev 指代客户端的部署位置
 server.vitium.dev 指代服务器的部署位置
 https%3A%2F%2Fserver.vitium.dev%2F 解码为 https://server.vitium.dev/
-->
<iframe
  src="https://client.vitium.dev/?server=https%3A%2F%2Fserver.vitium.dev%2F"
></iframe>

```

服务端应当尽可能地给予这个 `<iframe>` 足够大的显示空间，因为几乎全部用户交互发生在客户端页面上。
